import C from"axios";var l=C.create({baseURL:process.env.DPO_BASE_URL||"https://secure.3gdirectpay.com/API",headers:{"Content-Type":"application/xml"}});var c=class extends Error{code;constructor(t,e=0){super(t),this.name="DPOError",this.code=e}};import{isAxiosError as k}from"axios";function P(o){return o.replace(/[\s_-]+(\w)/g,function(t,e){return e.toUpperCase()}).replace(/(?:^\w|[A-Z]|\b\w)/g,function(t,e){return e===0?t.toLowerCase():t.toUpperCase()}).replace(/\s+/g,"")}import{XMLParser as f}from"fast-xml-parser";var d=o=>new f().parse(o);var p=(o,t=!0)=>{let e=d(o),s=e.API3G?.StatusCode||e.API3G?.Result,n=e.API3G?.ResultExplanation||"success",i=Object.entries(e.API3G).map(([m,a])=>{if(typeof a=="object"&&a!==null){let b=Object.entries(a).map(([y,u])=>({[P(y)]:u})).reduce((y,u)=>({...y,...u}));return{[P(m)]:b}}return{[P(m)]:a}}).reduce((m,a)=>({...m,...a}));switch(t&&(delete i.result,delete i.resultExplanation),s){case 0:case 130:case 900:case"success":return{...i,statusCode:200,message:n};default:return{...i,statusCode:400,message:n}}},R=o=>{try{return{dpoJsonResponse:p(o,!1),dpoXMLResponse:`
<?xml version="1.0" encoding="UTF-8"?>
<API3G>  
  <Response>OK</Response>
</API3G>
`}}catch(t){return{dpoJsonResponse:{status:"error",statusCode:500,message:t.message},dpoXMLResponse:`
<?xml version="1.0" encoding="UTF-8"?>
<API3G>
  <Response>Failed</Response>
  <Result>Failed</Result>
  <ResultExplanation>${t.message}</ResultExplanation>
</API3G>
`}}};var r=o=>{if(k(o)){delete o.response?.data["?xml"];let t=p(o.response?.data);throw new c(t,o.response?.status)}throw o};import{XMLBuilder as j}from"fast-xml-parser";var h=o=>`<?xml version="1.0" encoding="utf-8"?>${new j().build(o)}`;var O=class{companyToken;apiVersion;paymentURL;constructor({companyToken:t,apiVersion:e="v6"}){this.companyToken=t,this.apiVersion=e,this.paymentURL=process.env.DPO_PAYMENT_URL||"https://secure.3gdirectpay.com/payv3.php"}async processPaymentResponse(t){let e=h(t),s=await l.post(`/${this.apiVersion}/`,e);delete s.data["?xml"];let n=p(s.data);if(n.statusCode!==200)throw new c(JSON.stringify(n),n.statusCode);return n}async initiatePayment(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"createToken",...t}},s=await this.processPaymentResponse(e);return{...s,paymentURL:`${this.paymentURL}?ID=${s.transToken}`}}catch(e){return r(e)}}chargeMobilePayment(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"chargeTokenMobile",...t}};return this.processPaymentResponse(e)}catch(e){return r(e)}}chargeCardPayment(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"chargeTokenCreditCard",...t}};return this.processPaymentResponse(e)}catch(e){return r(e)}}refundPayment(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"refundToken",...t}};return this.processPaymentResponse(e)}catch(e){return r(e)}}cancelPayment(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"cancelToken",...t}};return this.processPaymentResponse(e)}catch(e){return r(e)}}checkPaymentStatus(t){try{let e={API3G:{CompanyToken:this.companyToken,Request:"verifyToken",...t}};return this.processPaymentResponse(e)}catch(e){return r(e)}}parseWebhookXML(t){return R(t)}};export{O as DPOPayment};
