"use strict";var J=Object.create;var g=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var K=(e,n)=>{for(var t in n)g(e,t,{get:n[t],enumerable:!0})},T=(e,n,t,o)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of X(n))!z.call(e,a)&&a!==t&&g(e,a,{get:()=>n[a],enumerable:!(o=O(n,a))||o.enumerable});return e};var $=(e,n,t)=>(t=e!=null?J(_(e)):{},T(n||!e||!e.__esModule?g(t,"default",{value:e,enumerable:!0}):t,e)),E=e=>T(g({},"__esModule",{value:!0}),e);var W={};K(W,{DPOPayment:()=>f,DPO_REQUEST_TYPE:()=>A,MOBILE_NETWORK_OPERATOR:()=>w,PAYMENT_STRATEGY_TYPE:()=>Z});module.exports=E(W);var x=require("axios");var u=class extends Error{code;response;constructor(n,t=0){super(n),this.name="DPOError",this.code=t,this.response=JSON.parse(n)}};function h(e){return e.replace(/[\s_-]+(\w)/g,function(n,t){return t.toUpperCase()}).replace(/(?:^\w|[A-Z]|\b\w)/g,function(n,t){return t===0?n.toLowerCase():n.toUpperCase()}).replace(/\s+/g,"")}var R=require("fast-xml-parser"),I=e=>new R.XMLParser().parse(e);var P=(e,n=!0)=>{let t=I(e),o=t.API3G?.StatusCode||t.API3G?.Result,a=t.API3G?.ResultExplanation||"success",p=Object.entries(t.API3G).map(([y,i])=>{if(typeof i=="object"&&i!==null){let s=Object.entries(i).map(([l,d])=>({[h(l)]:d})).reduce((l,d)=>({...l,...d}));return{[h(y)]:s}}return{[h(y)]:i}}).reduce((y,i)=>({...y,...i}));switch(n&&(delete p.result,delete p.resultExplanation),o){case 0:case 130:case 900:case"success":return{...p,statusCode:200,message:a};default:return{...p,statusCode:400,message:a}}},k=e=>{try{return{dpoJsonResponse:P(e,!1),dpoXMLResponse:`
<?xml version="1.0" encoding="UTF-8"?>
<API3G>  
  <Response>OK</Response>
</API3G>
`}}catch(n){return{dpoJsonResponse:{status:"error",statusCode:500,message:n.message},dpoXMLResponse:`
<?xml version="1.0" encoding="UTF-8"?>
<API3G>
  <Response>Failed</Response>
  <Result>Failed</Result>
  <ResultExplanation>${n.message}</ResultExplanation>
</API3G>
`}}};var c=e=>{if((0,x.isAxiosError)(e)){delete e.response?.data["?xml"];let n=P(e.response?.data);throw new u(n,e.response?.status)}throw e};var b=e=>{let{services:n,transaction:t}=e,{backURL:o,redirectURL:a,companyRef:p,paymentAmount:y,paymentCurrency:i,allowRecurrent:s,companyRefUnique:l,defaultPaymentCountry:d,ptl:F,ptlType:H,transactionChargeType:j,...q}=t;return{Transaction:{BackURL:o,RedirectURL:a,CompanyRef:p,PaymentAmount:y,PaymentCurrency:i,AllowRecurrent:s,CompanyRefUnique:l,DefaultPaymentCountry:d,PTL:F,PTLtype:H,TransactionChargeType:j,...q},Services:n.map(C=>({Service:{ServiceType:C.serviceType,ServiceDescription:C.serviceDescription,ServiceDate:C.serviceDate,ServiceFrom:C.serviceFrom,ServiceTo:C.serviceTo}})),Additional:e.additional}},N=e=>({MNO:e.mno,MNOcountry:e.mnoCountry,PhoneNumber:e.phoneNumber,TransactionToken:e.transactionToken}),D=e=>({TransactionToken:e.transactionToken,CardHolderName:e.cardHolderName,CreditCardCVV:e.creditCardCVV,CreditCardExpiry:e.creditCardExpiry,CreditCardNumber:e.creditCardNumber,ChargeType:e.chargeType}),S=e=>({refundAmount:e.refundAmount,refundDetails:e.refundDetails,TransactionToken:e.transactionToken}),M=e=>({TransactionToken:e.transactionToken}),v=e=>({TransactionToken:e.transactionToken});var L=$(require("axios")),G=L.default.create({baseURL:process.env.DPO_BASE_URL||"https://secure.3gdirectpay.com/API",headers:{"Content-Type":"application/xml"}});var U=require("fast-xml-parser"),V=e=>`<?xml version="1.0" encoding="utf-8"?>${new U.XMLBuilder().build(e)}`;async function m(e,n){let t=V(e),o=await G.post(`/${n}/`,t);delete o.data["?xml"];let a=P(o.data);if(a.statusCode!==200)throw new u(JSON.stringify(a),a.statusCode);return a}var w=(r=>(r.ZAMBIA_MTN="MTNZM",r.ZAMBIA_AIRTEL="AirtelZM",r.RWANDA_MTN="MTN",r.RWANDA_AIRTEL="AirtelRW",r.MALAWI_AIRTEL="AirtelMW",r.UGANDA_MTN="MTNmobilemoney",r.UGANDA_AIRTEL="Mobile_Airtel_UG",r.TANZANIA_SELCOM_ZANTEL="Selcom_webPay_Zantel",r.TANZANIA_SELCOM_HALOTEL="Selcom_webPay_Halotel",r.TANZANIA_TIGO="TIGOdebitMandate",r.TANZANIA_SELCOM="Selcom_webPay",r.TANZANIA_SELCOM_TTCL="Selcom_webPay_TTCL",r.TANZANIA_AIRTEL="AirtelTZ",r.GHANA_VODA="VodaGH",r.GHANA_MTN="MTN",r.KENYA_SAFARICOM="SafaricomSTKv2",r.KENYA_AIRTEL="AirtelKE",r.ZIMBABWE_ECOCASH="EcoCash",r))(w||{}),A=(s=>(s.CREATE_TOKEN="createToken",s.REFUND_TOKEN="refundToken",s.UPDATE_TOKEN="updateToken",s.VERIFY_TOKEN="verifyToken",s.CANCEL_TOKEN="cancelToken",s.CHARGE_TOKEN_BANK_TRANSFER="chargeTokenBankTransfer",s.CHARGE_TOKEN_CREDIT_CARD="chargeTokenCreditCard",s.CHARGE_TOKEN_MOBILE="chargeTokenMobile",s))(A||{}),Z=(t=>(t.MOBILE_MONEY="mobileMoney",t.CARD="card",t))(Z||{});var f=class{companyToken;apiVersion;paymentURL;constructor({companyToken:n,apiVersion:t="v6"}){this.companyToken=n,this.apiVersion=t,this.paymentURL=process.env.DPO_PAYMENT_URL||"https://secure.3gdirectpay.com/payv3.php"}async initiatePayment(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"createToken",...b(n)}},o=await m(t,this.apiVersion);return{...o,paymentURL:`${this.paymentURL}?ID=${o.transToken}`}}catch(t){return c(t)}}async processMobileMoneyPayment(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"chargeTokenMobile",...N(n)}};return m(t,this.apiVersion)}catch(t){return c(t)}}async processCardPayment(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"chargeTokenCreditCard",...D(n)}};return m(t,this.apiVersion)}catch(t){return c(t)}}refundPayment(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"refundToken",...S(n)}};return m(t,this.apiVersion)}catch(t){return c(t)}}cancelPayment(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"cancelToken",...M(n)}};return m(t,this.apiVersion)}catch(t){return c(t)}}checkPaymentStatus(n){try{let t={API3G:{CompanyToken:this.companyToken,Request:"verifyToken",...v(n)}};return m(t,this.apiVersion)}catch(t){return c(t)}}parseWebhookXML(n){return k(n)}};0&&(module.exports={DPOPayment,DPO_REQUEST_TYPE,MOBILE_NETWORK_OPERATOR,PAYMENT_STRATEGY_TYPE});
